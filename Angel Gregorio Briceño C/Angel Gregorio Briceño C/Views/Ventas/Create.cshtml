@model Angel_Gregorio_Briceño_C_.Models.Venta

@{
    ViewData["Title"] = "Crear Venta";
}

<h1>Crear Nueva Venta</h1>

<div class="row">
    <div class="col-md-8">
        <form asp-action="Create" id="ventaForm">
            <div class="form-group mb-3">
                <label class="control-label">Cliente</label>
                <select asp-for="ClienteId" class="form-control" asp-items="ViewBag.Clientes" required>
                    <option value="">Seleccionar Cliente</option>
                </select>
                <span asp-validation-for="ClienteId" class="text-danger"></span>
            </div>

            <h4>Productos</h4>
            <div id="productos-container">
                <div class="producto-item row mb-2">
                    <div class="col-md-5">
                        <select name="VentaDetalles[0].ProductoId" class="form-control producto-select" required>
                            <option value="">Seleccionar Producto</option>
                            @foreach (SelectListItem producto in ViewBag.Productos)
                            {
                                <option value="@producto.Value">@producto.Text</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input type="number" name="VentaDetalles[0].Cantidad" class="form-control cantidad" min="1" value="1" required>
                    </div>
                    <div class="col-md-3">
                        <input type="number" name="VentaDetalles[0].Precio" class="form-control precio" step="0.01" min="0.01" placeholder="Precio" required>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-danger btn-sm remove-producto">Eliminar</button>
                    </div>
                </div>
            </div>

            <button type="button" id="add-producto" class="btn btn-secondary btn-sm mb-3">Agregar Producto</button>

            <div class="form-group mb-3">
                <label class="control-label">Total: </label>
                <span id="total-venta" class="fw-bold">$0.00</span>
            </div>

            <div class="form-group mt-3">
                <button type="submit" class="btn btn-success">Crear Venta</button>
                <a asp-action="Index" class="btn btn-secondary">Cancelar</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        let productoIndex = 1;

        // Agregar producto
        document.getElementById('add-producto').addEventListener('click', function() {
            const container = document.getElementById('productos-container');
            const newProducto = container.firstElementChild.cloneNode(true);

            // Actualizar índices
            newProducto.querySelectorAll('[name]').forEach(input => {
                input.name = input.name.replace(/\[\d+\]/, `[${productoIndex}]`);
            });

            // Limpiar valores
            newProducto.querySelector('.producto-select').value = '';
            newProducto.querySelector('.cantidad').value = 1;
            newProducto.querySelector('.precio').value = '';

            container.appendChild(newProducto);
            productoIndex++;
        });

        // Eliminar producto
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-producto')) {
                if (document.querySelectorAll('.producto-item').length > 1) {
                    e.target.closest('.producto-item').remove();
                    calcularTotal();
                }
            }
        });

        // Actualizar precio automáticamente cuando se selecciona producto
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('producto-select')) {
                const productoId = e.target.value;
                const precioInput = e.target.closest('.producto-item').querySelector('.precio');

                if (productoId) {
                    // Llamar al método del controlador para obtener el precio
                    fetch(`/Ventas/GetPrecioProducto?id=${productoId}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Error en la respuesta del servidor');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.precio) {
                                precioInput.value = data.precio;
                                calcularTotal();
                            }
                        })
                        .catch(error => {
                            console.error('Error al obtener precio:', error);
                            // Si falla, dejar que el usuario ingrese el precio manualmente
                            precioInput.value = '';
                            precioInput.placeholder = "Ingresa precio manual";
                        });
                }
            }
        });

        // Calcular total cuando cambia cantidad o precio
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('cantidad') || e.target.classList.contains('precio')) {
                calcularTotal();
            }
        });

        function calcularTotal() {
            let total = 0;
            document.querySelectorAll('.producto-item').forEach(item => {
                const cantidad = parseFloat(item.querySelector('.cantidad').value) || 0;
                const precio = parseFloat(item.querySelector('.precio').value) || 0;
                total += cantidad * precio;
            });
            document.getElementById('total-venta').textContent = '$' + total.toFixed(2);
        }

        // Calcular total inicial
        calcularTotal();
    </script>

    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}